<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
 #calendar {
      max-width: 900px;
      margin: 40px auto 60px; /* ä¸‹ã«å°‘ã—ã‚†ã¨ã‚Šè¿½åŠ  */
      background-color: white;
     padding: 20px;
     border-radius: 10px;
     box-shadow: 0 0 10px rgba(0,0,0,0.05);
     padding-bottom: 40px;
    }

    body {
  font-family: 'Helvetica Neue', sans-serif;
  background-color: #f9f9f9;
  margin: 0;
  padding: 20px;
  color: #333;
}

h1, h2 {
  text-align: center;
  color: #2c3e50;
}



    .fc-event {
      font-size: 0.75rem;     /* æ–‡å­—ã‚’å°‘ã—å°ã•ã‚ã«ã—ã¦ */
      white-space: normal;    /* æŠ˜ã‚Šè¿”ã—ã‚’è¨±å¯ */
      line-height: 1.2;       /* è¡Œé–“ã‚’èª¿æ•´ */
      padding: 2px;           /* å°‘ã—ä½™ç™½ã‚’èª¿æ•´ */
    }
  
    .fc-daygrid-event {
      min-height: 2.5em;      /* ã‚¤ãƒ™ãƒ³ãƒˆæ ã®é«˜ã•ã‚’åºƒã’ã‚‹ */
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

</head>
<body>
  <h1>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
  <h2>ã”å¸Œæœ›ã®æ—¥æ™‚ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</h2>
  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div id="calendar-container">
  <div id="calendar"></div>
  </div>
  <a href="/">TOPã«æˆ»ã‚‹</a>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
    
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        events: function(fetchInfo, successCallback, failureCallback) {
  const start = fetchInfo.startStr; // ãƒ•ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¡¨ç¤ºã•ã‚Œã‚‹æœˆåˆæ—¥
  const end = fetchInfo.endStr;     // ãƒ•ãƒ«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¡¨ç¤ºã•ã‚Œã‚‹æœˆæœ«æ—¥
  console.log('ğŸ“¤ FullCalendarãŒè¦æ±‚ã—ãŸç¯„å›²:', start, end);  // â†è¿½åŠ 

  $.get(`/api/reservations/range?start=${start}&end=${end}`, function(data) {
    console.log('APIã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', data); // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿

    if (data && data.length > 0) {
      const events = data.map(item => ({
        title: item.title,
        start: item.start,
        allDay: true,
        extendedProps: item.extendedProps
  
      }))
      .filter(event => !event.extendedProps?.disabled);
      console.log('FullCalendarã«æ¸¡ã™ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿:', events); // æ¸¡ã™ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
      successCallback(events); // eventsãƒ‡ãƒ¼ã‚¿ã‚’FullCalendarã«æ¸¡ã™
    } else {
      console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚');
      failureCallback('ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚');
    }
  }).fail(function() {
    console.error('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—');
    failureCallback('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—');
  });
},


eventDidMount: function(info) {
  const title = info.event.title;


  if (title.includes('æ®‹ã‚Šï¼•æ ')) {
    $(info.el).css('background-color', '#0095d9'); 
  } else if(title.includes('ç©ºããªã—')) {
    $(info.el).css('background-color', '#adadad'); // ã‚°ãƒ¬ãƒ¼
  } else
    {
    const match = title.match(/æ®‹ã‚Š\s(\d+)\sæ /);
    const remaining = match ? parseInt(match[1]) : null;

     if (remaining < 3) {
      $(info.el).css('background-color', '#e60033'); // èµ¤
      $(info.el).find('.fc-event-title').css('color', 'black');
    } else {
      $(info.el).css('background-color', '#0095d9'); // ç·‘
    }
  }
  const { course, timeslot, remaining } = info.event.extendedProps;
  if (course && timeslot) {
    tippy(info.el, {
      content: `
        <strong>ã‚³ãƒ¼ã‚¹:</strong> ${course}<br>
        <strong>æ™‚é–“:</strong> ${timeslot}<br>
        <strong>æ®‹æ :</strong> ${remaining} æ 
      `,
      allowHTML: true,
      theme: 'light',
      placement: 'top',
    });
  }
},

dateClick: function(info) {
  const clickedDate = info.dateStr; // ä¾‹: '2025-05-18'
  window.location.href = `/reserve?date=${clickedDate}`;
},
eventClick: function(info) {
  const dateStr = info.event.startStr;
  window.location.href = `/reserve?date=${dateStr}`;
}

}
      );
     
calendar.render();
    });
  </script>
</body>
</html>
